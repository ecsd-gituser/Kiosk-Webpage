<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECSD Kiosk OTP Login</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* Your existing styles here */
    </style>
    <script>
        let timeout;
        const SESSION_TIMEOUT = 60000; // 1 minute in milliseconds

        function startTimer() {
            timeout = setTimeout(() => {
                window.location.href = 'logout.html';
            }, SESSION_TIMEOUT);
        }

        window.onload = function() {
            startTimer();
        };

        // Optionally reset timer on user interaction
        document.onclick = function() {
            clearTimeout(timeout);
            startTimer();
        };

        // Prevent going back after logout
        window.history.replaceState(null, null, window.location.href);
        window.onpopstate = function () {
            window.location.href = 'logout.html';
        };
    </script>
</head>
<body>
    <div class="container">
        <img src="assets/icon.png" alt="ECSD Logo" class="logo">
        <h1>Welcome to ECSD Kiosk Browser</h1>
        <p>Please enter the OTP to access the app:</p>
        <input type="text" id="otp" placeholder="Enter OTP" maxlength="6">
        <button id="loginButton">Login</button>
        <p id="error-message" class="error"></p>
    </div>

    <script>
        console.log('Script started');

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM content loaded');
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                console.log('Login button found, attaching click event');
                loginButton.addEventListener('click', validateOTP);
            } else {
                console.error('Login button not found');
            }
        });

        function validateOTP() {
            console.log('validateOTP function called');
            
            const enteredOTP = document.getElementById('otp').value;
            console.log('Entered OTP:', enteredOTP);
            
            const secretKey = 'JBSWY3DPEHPK3PXP'; // Replace with your secret key
            console.log('Secret Key:', secretKey);
            
            const generatedOTP = generateTOTP(secretKey);
            console.log('Generated OTP:', generatedOTP);

            if (enteredOTP === generatedOTP) {
                console.log('OTP validation successful');
                clearTimeout(timeout); // Clear the logout timer
                if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
                    chrome.runtime.sendMessage({action: "startTimer"}, function(response) {
                        console.log(response.status);
                        window.location.href = 'app.html';
                    });
                } else {
                    window.location.href = 'app.html';
                }
            } else {
                console.log('OTP validation failed');
                document.getElementById('error-message').textContent = 'Invalid OTP, please try again.';
            }
        }

        // Your existing generateTOTP, dec2hex, and leftpad functions here

        console.log('Script ended');
    </script>
</body>
</html>
